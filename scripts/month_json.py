import requests
import pandas as pd
import json
from collections import defaultdict

legal_stations_2018 = ['41110', '41113', '41114', '41115', '41117', '41159', '42097', '42098', '42099', '42361', '42364', '42390', '42394', '44022', '44039', '44040', '44056', '44086', '44087', '44089', '44090', '44091', '44095', '44096', '44097', '44098', '44099', '44100', '45020', '45169', '45172', '45173', '45174', '45180', '46092', '46114', '46118', '46211', '46213', '46214', '46215', '46217', '46218', '46219', '46221', '46222', '46224', '46225', '46229', '46232', '46235', '46239', '46240', '46242', '46243', '46244', '46246', '46248', '46251', '46253', '46254', '46256', '46258', '46259', '46265', '51201', '51202', '51205', '51206', '51207', '51208', '51209', '51210', '51212', '51213', '52200', '52201', '52202', '52211', 'AAMC1', 'ACYN4', 'ADKA2', 'AGCM4', 'AGXC1', 'AJXA2', 'ALIA2', 'ALXN6', 'AMRL1', 'ANPT2', 'ANTA2', 'ANVC1', 'APAM2', 'APCF1', 'APNM4', 'APRP7', 'AROP4', 'ARPF1', 'ASTO3', 'ATGM1', 'ATKA2', 'AWRT2', 'BABT2', 'BARA9', 'BATN6', 'BAXC1', 'BDRN4', 'BDSP1', 'BEPB6', 'BFTN7', 'BGCF1', 'BGNN6', 'BHBM3', 'BHRI3', 'BIGM4', 'BISM2', 'BKTL1', 'BLIF1', 'BLTA2', 'BLTM2', 'BLTM3', 'BRHC3', 'BRND1', 'BSBM4', 'BTHD1', 'BUFN6', 'BYGL1', 'BZBM3', 'BZST2', 'CAMM2', 'CAPL1', 'CARL1', 'CASM1', 'CBLO1', 'CBRW3', 'CDEA2', 'CDXA2', 'CECC1', 'CFWM1', 'CHAO3', 'CHAV3', 'CHBV2', 'CHCM2', 'CHDS1', 'CHII2', 'CHSV3', 'CHTS1', 'CHYV2', 'CHYW1', 'CLBP4', 'CLSM4', 'CMAN4', 'CMTI2', 'CNDO1', 'CNII2', 'COVM2', 'CPMW1', 'CPTR1', 'CPVM2', 'CRVA2', 'CRYV2', 'CSPA2', 'CWBF1', 'DELD1', 'DKCM6', 'DMSF1', 'DOMV2', 'DPXC1', 'DTLM4', 'DUKN7', 'DULM5', 'EBSW1', 'EINL1', 'ELFA2', 'EMAT2', 'EPTT2', 'EREP1', 'EROA2', 'ERXA2', 'ESPP4', 'FAIO1', 'FCGT2', 'FHPF1', 'FMOA1', 'FMRF1', 'FOXR1', 'FPKG1', 'FPST2', 'FPTM4', 'FRCB6', 'FRDF1', 'FRDW1', 'FREL1', 'FRFN7', 'FRVM3', 'FRWL1', 'FRXM3', 'FSKM2', 'FSNM2', 'FSTI2', 'FTGM4', 'FTPC1', 'GCTF1', 'GDMM5', 'GISL1', 'GIXA2', 'GNJT2', 'GRIM4', 'GRMM4', 'GRRT2', 'GSLM4', 'GTLM4', 'GTOT2', 'GTRM4', 'GUXA2', 'HAXA2', 'HBYC1', 'HCGN7', 'HHLO1', 'HIST2', 'HLNM4', 'HMSA2', 'HRBM4', 'HRVC1', 'ICAC1', 'ICYA2', 'ILOH1', 'IRDT2', 'ITKA2', 'JAKI2', 'JLXA2', 'JMLA2', 'JMPN7', 'JNEA2', 'JXUF1', 'KDAA2', 'KECA2', 'KEXA2', 'KGCA2', 'KLIH1', 'KNSW3', 'KPTN6', 'KPTV2', 'KWHH1', 'KWJP8', 'KWNW3', 'KYWF1', 'LAMV3', 'LAPW1', 'LCLL1', 'LCNA2', 'LDLC3', 'LDTM4', 'LIXA2', 'LJAC1', 'LJPC1', 'LMFS1', 'LNDC1', 'LOPL1', 'LOPW1', 'LORO1', 'LPNM4', 'LTBV3', 'LTJF1', 'LTRM4', 'LUIT2', 'LWSD1', 'LWTV2', 'MACM4', 'MBET2', 'MBPA1', 'MBRM4', 'MCGA1', 'MCGM4', 'MCYF1', 'MCYI3', 'MEEM4', 'MEYC1', 'MGIP4', 'MGPT2', 'MGZP4', 'MHRN6', 'MISP4', 'MKGM4', 'MLWW3', 'MNMM4', 'MNPV2', 'MOKH1', 'MQTT2', 'MRCP1', 'MRHO1', 'MRNA2', 'MROS1', 'MRSL1', 'MRYA2', 'MTBF1', 'MTKN6', 'MVXA2', 'MXXA2', 'MYPF1', 'MZXC1', 'NABM4', 'NBBA3', 'NBLP1', 'NCDV2', 'NCHT2', 'NEAW1', 'NIAN6', 'NKLA2', 'NKTA2', 'NKXA2', 'NLMA3', 'NLNC3', 'NMTA2', 'NPDW3', 'NPSF1', 'NSTP6', 'NTBC1', 'NTKM3', 'NUET2', 'NWCL1', 'NWHC3', 'NWPR1', 'NWWH1', 'OBGN6', 'OBLA1', 'OBXC1', 'OCIM2', 'OCSM2', 'OHBC1', 'OKSI2', 'OKXC1', 'OLCN6', 'OLSA2', 'OMHC1', 'OOUH1', 'OPTF1', 'ORIN7', 'OSGN6', 'OVIA2', 'PACF1', 'PACT2', 'PAXA2', 'PBPA2', 'PCBF1', 'PCGT2', 'PCLF1', 'PCLM4', 'PCNT2', 'PCOC1', 'PEGF1', 'PFDC1', 'PFXC1', 'PGBP7', 'PGXA2', 'PHBP1', 'PILL1', 'PLXA2', 'PMAF1', 'PMNT2', 'PNLM4', 'PNLM6', 'PORO3', 'PORT2', 'PPTM2', 'PPXC1', 'PRDA2', 'PRJC1', 'PRTA2', 'PRUR1', 'PRYC1', 'PSBC1', 'PSBM1', 'PSCM4', 'PSLC1', 'PSTL1', 'PSTN6', 'PSXC1', 'PTAW1', 'PTBM6', 'PTCR1', 'PTIM4', 'PTIT2', 'PTLA2', 'PTOA1', 'PTRP4', 'PTWW1', 'PVDR1', 'PWAW3', 'PXAC1', 'PXOC1', 'PXSC1', 'QPTR1', 'RARM6', 'RCKM4', 'RCMC1', 'RCPT2', 'RCRN6', 'RCYF1', 'RDDA2', 'RDYD1', 'RIXA2', 'RLIT2', 'RLOT2', 'ROBN4', 'RPLV2', 'RPRN6', 'RSJT2', 'RTAT2', 'RTYC1', 'SAPF1', 'SBBN2', 'SBEO3', 'SBLM4', 'SBPT2', 'SCXA2', 'SDBC1', 'SDHN4', 'SDIA2', 'SDRT2', 'SGNT2', 'SHBL1', 'SHPF1', 'SHXA2', 'SISA2', 'SJNP4', 'SJOM4', 'SJSN4', 'SKTA2', 'SKXA2', 'SLIM2', 'SLMN2', 'SLVM5', 'SLXA2', 'SNDA2', 'SNDP5', 'SPLL1', 'SRLM4', 'STXA2', 'SVNM4', 'SWLA2', 'SWPM4', 'SWPV2', 'SXHW3', 'TAQT2', 'TAWM4', 'TBIM4', 'TCBM2', 'TCMW1', 'TCNW1', 'TESL1', 'THLO1', 'THRO1', 'TKEA2', 'TLBO3', 'TOKW1', 'TPAF1', 'TRDF1', 'TSHF1', 'TWCO1', 'TXPT2', 'ULAM6', 'ULRA2', 'UNLA2', 'VAKF1', 'VBBA3', 'VCAF1', 'VCAT2', 'VCVA2', 'VDZA2', 'WAHV2', 'WAKP8', 'WASD2', 'WATS1', 'WBYA1', 'WDEL1', 'WDSV2', 'WELM1', 'WFPM4', 'WHRI2', 'WLON7', 'WNEM4', 'WPTW1', 'WSLM4', 'WYCM6', 'YABP4', 'YATA2', 'YGNN6', 'YKRV2', 'YKTV2']

legal_stations_2019 = ['41110', '41113', '41114', '41115', '41117', '41159', '42097', '42098', '42099', '44022', '44039', '44040', '44056', '44073', '44086', '44087', '44089', '44090', '44091', '44095', '44097', '44098', '44099', '44100', '45169', '45172', '45173', '45174', '46092', '46114', '46118', '46211', '46213', '46214', '46215', '46217', '46218', '46219', '46221', '46222', '46224', '46225', '46229', '46232', '46235', '46239', '46240', '46242', '46243', '46244', '46246', '46248', '46251', '46253', '46254', '46256', '46258', '46259', '46265', '51201', '51202', '51205', '51206', '51207', '51208', '51209', '51210', '51212', '51213', '52200', '52201', '52202', '52211', 'AAMC1', 'ACYN4', 'ADKA2', 'AGCM4', 'AGXC1', 'AJXA2', 'ALIA2', 'ALXN6', 'AMRL1', 'ANPT2', 'ANTA2', 'ANVC1', 'APAM2', 'APCF1', 'APNM4', 'APRP7', 'AROP4', 'ARPF1', 'ASTO3', 'ATGM1', 'ATKA2', 'AWRT2', 'BABT2', 'BARA9', 'BATN6', 'BAXC1', 'BDRN4', 'BDSP1', 'BEPB6', 'BFTN7', 'BGCF1', 'BGNN6', 'BHBM3', 'BHRI3', 'BIGM4', 'BISM2', 'BKTL1', 'BLIF1', 'BLTA2', 'BLTM2', 'BLTM3', 'BRHC3', 'BRND1', 'BSBM4', 'BUFN6', 'BYGL1', 'BZBM3', 'BZST2', 'CAMM2', 'CAPL1', 'CARL1', 'CASM1', 'CBLO1', 'CBRW3', 'CDEA2', 'CDXA2', 'CECC1', 'CFWM1', 'CHAO3', 'CHAV3', 'CHBV2', 'CHCM2', 'CHDS1', 'CHII2', 'CHSV3', 'CHTS1', 'CHYV2', 'CHYW1', 'CLBP4', 'CLSM4', 'CMAN4', 'CMLN3', 'CMPO1', 'CMTI2', 'CNDO1', 'CNII2', 'COVM2', 'CPMW1', 'CPNW1', 'CPTR1', 'CPVM2', 'CRVA2', 'CRYV2', 'CSPA2', 'CWBF1', 'DELD1', 'DMSF1', 'DOMV2', 'DPXC1', 'DTLM4', 'DUKN7', 'DULM5', 'EBSW1', 'EINL1', 'ELFA2', 'EMAT2', 'EPTT2', 'EREP1', 'EROA2', 'ERXA2', 'ESPP4', 'FAIO1', 'FCGT2', 'FHPF1', 'FMOA1', 'FMRF1', 'FOXR1', 'FPKG1', 'FPST2', 'FPTM4', 'FRCB6', 'FRDF1', 'FRDW1', 'FREL1', 'FRFN7', 'FRVM3', 'FRWL1', 'FRXM3', 'FSKM2', 'FSNM2', 'FSTI2', 'FTGM4', 'FTPC1', 'GCTF1', 'GDMM5', 'GELO1', 'GISL1', 'GIXA2', 'GNJT2', 'GRIM4', 'GRMM4', 'GRRT2', 'GSLM4', 'GTLM4', 'GTOT2', 'GTRM4', 'GUXA2', 'HAXA2', 'HBYC1', 'HCGN7', 'HHLO1', 'HIST2', 'HLNM4', 'HMSA2', 'HRBM4', 'HRVC1', 'ICAC1', 'ICYA2', 'ILOH1', 'IRDT2', 'ITKA2', 'JAKI2', 'JLXA2', 'JMLA2', 'JMPN7', 'JNEA2', 'JXUF1', 'KDAA2', 'KECA2', 'KEXA2', 'KGCA2', 'KLIH1', 'KNSW3', 'KPTN6', 'KPTV2', 'KWHH1', 'KWJP8', 'KWNW3', 'KYWF1', 'LAMV3', 'LAPW1', 'LCLL1', 'LCNA2', 'LDLC3', 'LDTM4', 'LIXA2', 'LJAC1', 'LJPC1', 'LMFS1', 'LNDC1', 'LOPL1', 'LOPW1', 'LORO1', 'LPNM4', 'LTBV3', 'LTJF1', 'LTRM4', 'LUIT2', 'LWSD1', 'LWTV2', 'MACM4', 'MBET2', 'MBPA1', 'MBRM4', 'MCGA1', 'MCGM4', 'MCYF1', 'MCYI3', 'MEEM4', 'MEYC1', 'MGIP4', 'MGPT2', 'MGZP4', 'MHRN6', 'MISP4', 'MKGM4', 'MLWW3', 'MNMM4', 'MNPV2', 'MOKH1', 'MQTT2', 'MRCP1', 'MRHO1', 'MRNA2', 'MROS1', 'MRSL1', 'MRYA2', 'MTBF1', 'MTKN6', 'MVXA2', 'MXXA2', 'MYPF1', 'MZXC1', 'NABM4', 'NBBA3', 'NBLP1', 'NCDV2', 'NCHT2', 'NEAW1', 'NFDF1', 'NIAN6', 'NKLA2', 'NKTA2', 'NKXA2', 'NLMA3', 'NLNC3', 'NMTA2', 'NPDW3', 'NPSF1', 'NREP1', 'NSTP6', 'NTBC1', 'NTKM3', 'NUET2', 'NWCL1', 'NWHC3', 'NWPR1', 'NWWH1', 'OBGN6', 'OBLA1', 'OBXC1', 'OCIM2', 'OCSM2', 'OHBC1', 'OKSI2', 'OKXC1', 'OLCN6', 'OLSA2', 'OMHC1', 'OOUH1', 'OPTF1', 'ORIN7', 'OSGN6', 'OVIA2', 'PACF1', 'PACT2', 'PAXA2', 'PBPA2', 'PCBF1', 'PCGT2', 'PCLF1', 'PCLM4', 'PCNT2', 'PCOC1', 'PEGF1', 'PFDC1', 'PFXC1', 'PGBP7', 'PGXA2', 'PHBP1', 'PILL1', 'PLXA2', 'PMAF1', 'PMNT2', 'PNLM4', 'PNLM6', 'PORO3', 'PORT2', 'PPTM2', 'PPXC1', 'PRDA2', 'PRJC1', 'PRTA2', 'PRUR1', 'PRYC1', 'PSBC1', 'PSBM1', 'PSCM4', 'PSLC1', 'PSTL1', 'PSTN6', 'PSXC1', 'PTAW1', 'PTBM6', 'PTCR1', 'PTIM4', 'PTIT2', 'PTLA2', 'PTOA1', 'PTRP4', 'PTWW1', 'PVDR1', 'PWAW3', 'PXAC1', 'PXOC1', 'PXSC1', 'QPTR1', 'RCKM4', 'RCMC1', 'RCPT2', 'RCRN6', 'RCYF1', 'RDDA2', 'RDYD1', 'RIXA2', 'RLIT2', 'RLOT2', 'ROBN4', 'RPLV2', 'RPRN6', 'RSJT2', 'RTAT2', 'RTYC1', 'SAPF1', 'SBBN2', 'SBEO3', 'SBLM4', 'SBPT2', 'SCXA2', 'SDBC1', 'SDHN4', 'SDIA2', 'SDRT2', 'SGNT2', 'SHBL1', 'SHPF1', 'SHXA2', 'SISA2', 'SJNP4', 'SJOM4', 'SJSN4', 'SKTA2', 'SKXA2', 'SLIM2', 'SLMN2', 'SLXA2', 'SNDA2', 'SNDP5', 'SPLL1', 'SRLM4', 'STXA2', 'SVNM4', 'SWLA2', 'SWPM4', 'SWPV2', 'SXHW3', 'TAQT2', 'TAWM4', 'TBIM4', 'TCBM2', 'TCMW1', 'TCNW1', 'TESL1', 'THLO1', 'THRO1', 'TKEA2', 'TLBO3', 'TOKW1', 'TPAF1', 'TRDF1', 'TSHF1', 'TWCO1', 'TXPT2', 'ULRA2', 'UNLA2', 'UPBC1', 'VAKF1', 'VBBA3', 'VCAF1', 'VCAT2', 'VCVA2', 'VDZA2', 'WAHV2', 'WAKP8', 'WASD2', 'WATS1', 'WBYA1', 'WDSV2', 'WELM1', 'WFPM4', 'WHRI2', 'WLON7', 'WNEM4', 'WPTW1', 'WSLM4', 'WYCM6', 'YABP4', 'YATA2', 'YGNN6', 'YKRV2', 'YKTV2']

legal_stations_2020 = ['41110', '41113', '41114', '41115', '41117', '41159', '42097', '42098', '42099', '44022', '44040', '44056', '44073', '44086', '44087', '44089', '44090', '44091', '44095', '44097', '44098', '44099', '44100', '45169', '45172', '45173', '45174', '45180', '46092', '46114', '46118', '46211', '46213', '46214', '46215', '46218', '46219', '46221', '46222', '46224', '46225', '46229', '46232', '46235', '46239', '46240', '46243', '46244', '46246', '46248', '46251', '46253', '46254', '46256', '46258', '46259', '46265', '4H361', '4H390', '4H394', '51201', '51202', '51205', '51206', '51207', '51208', '51209', '51210', '51212', '51213', '52200', '52201', '52202', '52211', 'AAMC1', 'ACYN4', 'ADKA2', 'AGCM4', 'AGXC1', 'AJXA2', 'ALIA2', 'ALXN6', 'AMRL1', 'ANPT2', 'ANTA2', 'ANVC1', 'APAM2', 'APCF1', 'APNM4', 'APRP7', 'AROP4', 'ARPF1', 'ASTO3', 'ATGM1', 'ATKA2', 'AWRT2', 'BABT2', 'BARA9', 'BATN6', 'BAXC1', 'BDRN4', 'BDSP1', 'BFTN7', 'BGCF1', 'BGNN6', 'BHBM3', 'BHRI3', 'BIGM4', 'BISM2', 'BKTL1', 'BLIF1', 'BLTA2', 'BLTM2', 'BLTM3', 'BRHC3', 'BRND1', 'BSBM4', 'BUFN6', 'BYGL1', 'BZBM3', 'BZST2', 'CAMM2', 'CAPL1', 'CARL1', 'CASM1', 'CBLO1', 'CBRW3', 'CDEA2', 'CDXA2', 'CECC1', 'CFWM1', 'CHAO3', 'CHAV3', 'CHBV2', 'CHCM2', 'CHDS1', 'CHII2', 'CHSV3', 'CHTM3', 'CHTS1', 'CHYV2', 'CHYW1', 'CLBP4', 'CLSM4', 'CMAN4', 'CMLN3', 'CMPO1', 'CMTI2', 'CNDO1', 'CNII2', 'COVM2', 'CPMW1', 'CPNW1', 'CPTR1', 'CPVM2', 'CRGA2', 'CRVA2', 'CRYV2', 'CSPA2', 'CWBF1', 'DELD1', 'DMSF1', 'DOMV2', 'DPXC1', 'DTLM4', 'DUKN7', 'DULM5', 'EBEF1', 'EINL1', 'ELFA2', 'EMAT2', 'EPTT2', 'EREP1', 'EROA2', 'ERXA2', 'ESPP4', 'FAIO1', 'FCGT2', 'FHPF1', 'FMOA1', 'FMRF1', 'FOXR1', 'FPKG1', 'FPST2', 'FPTM4', 'FRCB6', 'FRDF1', 'FRDW1', 'FREL1', 'FRFN7', 'FRVM3', 'FRWL1', 'FRXM3', 'FSKM2', 'FSNM2', 'FSTI2', 'FTGM4', 'FTPC1', 'GBWW3', 'GCTF1', 'GDMM5', 'GELO1', 'GEXA2', 'GISL1', 'GIXA2', 'GNJT2', 'GRIM4', 'GRMM4', 'GRRT2', 'GSLM4', 'GTLM4', 'GTOT2', 'GTRM4', 'GUXA2', 'HAXA2', 'HBYC1', 'HCGN7', 'HHLO1', 'HIST2', 'HLNM4', 'HMSA2', 'HRBM4', 'HRVC1', 'ICAC1', 'ICYA2', 'ILOH1', 'IRDT2', 'ITKA2', 'JAKI2', 'JLXA2', 'JMLA2', 'JMPN7', 'JNEA2', 'JNGA2', 'JXUF1', 'KDAA2', 'KECA2', 'KEXA2', 'KGCA2', 'KLIH1', 'KNSW3', 'KPTN6', 'KPTV2', 'KWHH1', 'KWJP8', 'KWNW3', 'KYWF1', 'LAMV3', 'LAPW1', 'LCLL1', 'LCNA2', 'LDLC3', 'LDTM4', 'LIXA2', 'LJAC1', 'LJPC1', 'LMFS1', 'LNDC1', 'LOPL1', 'LOPW1', 'LORO1', 'LPNM4', 'LTBV3', 'LTJF1', 'LTRM4', 'LUIT2', 'LWSD1', 'LWTV2', 'MACM4', 'MBET2', 'MBIN7', 'MBPA1', 'MBRM4', 'MCGA1', 'MCGM4', 'MCYF1', 'MCYI3', 'MEEM4', 'MEYC1', 'MGIP4', 'MGPT2', 'MGZP4', 'MHBT2', 'MHRN6', 'MISP4', 'MKGM4', 'MLWW3', 'MNMM4', 'MNPV2', 'MOKH1', 'MQTT2', 'MRCP1', 'MRHO1', 'MRNA2', 'MROS1', 'MRSL1', 'MRYA2', 'MTBF1', 'MTKN6', 'MVXA2', 'MXXA2', 'MYPF1', 'MZXC1', 'NABM4', 'NBBA3', 'NBLP1', 'NCDV2', 'NCHT2', 'NEAW1', 'NFDF1', 'NIAN6', 'NJLC1', 'NKLA2', 'NKTA2', 'NKXA2', 'NLMA3', 'NLNC3', 'NMTA2', 'NPDW3', 'NPSF1', 'NREP1', 'NSTP6', 'NTBC1', 'NTKM3', 'NUET2', 'NWCL1', 'NWHC3', 'NWPR1', 'NWWH1', 'OBGN6', 'OBLA1', 'OBXC1', 'OCIM2', 'OCSM2', 'OHBC1', 'OKSI2', 'OKXC1', 'OLCN6', 'OLSA2', 'OMHC1', 'OOUH1', 'OPTF1', 'ORIN7', 'OSGN6', 'OTNM4', 'OVIA2', 'PACF1', 'PACT2', 'PAXA2', 'PBPA2', 'PCBF1', 'PCGT2', 'PCLF1', 'PCLM4', 'PCNT2', 'PCOC1', 'PEGF1', 'PFDC1', 'PFXC1', 'PGBP7', 'PGXA2', 'PHBP1', 'PILL1', 'PLXA2', 'PMAF1', 'PMNT2', 'PNGW3', 'PNLM4', 'PNLM6', 'PORO3', 'PORT2', 'PPTM2', 'PPXC1', 'PRDA2', 'PRJC1', 'PRTA2', 'PRUR1', 'PRYC1', 'PSBC1', 'PSBM1', 'PSCM4', 'PSLC1', 'PSTL1', 'PSTN6', 'PSXC1', 'PTAW1', 'PTBM6', 'PTCR1', 'PTIM4', 'PTIT2', 'PTLA2', 'PTOA1', 'PTRP4', 'PTWW1', 'PVDR1', 'PWAW3', 'PXAC1', 'PXOC1', 'PXSC1', 'QPTR1', 'RCKM4', 'RCMC1', 'RCPT2', 'RCRN6', 'RDDA2', 'RDYD1', 'RIXA2', 'RLIT2', 'RLOT2', 'ROBN4', 'RPLV2', 'RPRN6', 'RSJT2', 'RTAT2', 'RTYC1', 'SAPF1', 'SBBN2', 'SBEO3', 'SBLM4', 'SBPT2', 'SCXA2', 'SDBC1', 'SDHN4', 'SDIA2', 'SDRT2', 'SGNT2', 'SHBL1', 'SHPF1', 'SHXA2', 'SISA2', 'SJNP4', 'SJOM4', 'SJSN4', 'SKCF1', 'SKTA2', 'SKXA2', 'SLIM2', 'SLMN2', 'SLVM5', 'SLXA2', 'SNDA2', 'SNDP5', 'SPLL1', 'SRLM4', 'STXA2', 'SVNM4', 'SWLA2', 'SWPM4', 'SWPV2', 'SXHW3', 'TAQT2', 'TAWM4', 'TBIM4', 'TCBM2', 'TCMW1', 'TCNW1', 'TESL1', 'THLO1', 'THRO1', 'TKEA2', 'TLBO3', 'TOKW1', 'TPAF1', 'TRDF1', 'TSHF1', 'TWCO1', 'TXPT2', 'ULRA2', 'UNLA2', 'UPBC1', 'VAKF1', 'VBBA3', 'VCAF1', 'VCAT2', 'VCVA2', 'VDZA2', 'WAHV2', 'WAKP8', 'WASD2', 'WATS1', 'WBYA1', 'WDEL1', 'WDSV2', 'WELM1', 'WFPM4', 'WHRI2', 'WLON7', 'WNEM4', 'WPTW1', 'WSLM4', 'WYCM6', 'YABP4', 'YATA2', 'YKRV2', 'YKTV2']

legal_stations_2021 = ['41110', '41113', '41114', '41115', '41117', '41159', '42097', '42098', '42099', '44022', '44039', '44040', '44056', '44073', '44086', '44087', '44089', '44090', '44091', '44095', '44097', '44098', '44099', '44100', '45174', '45180', '46092', '46114', '46211', '46213', '46214', '46215', '46218', '46219', '46221', '46222', '46224', '46225', '46229', '46232', '46235', '46239', '46240', '46243', '46244', '46246', '46248', '46251', '46253', '46254', '46256', '46258', '46259', '4H361', '4H390', '4H394', '51201', '51202', '51205', '51206', '51207', '51208', '51209', '51210', '51212', '51213', '52200', '52201', '52202', '52211', 'AAMC1', 'ACYN4', 'ADKA2', 'AGCM4', 'AGXC1', 'ALIA2', 'ALXN6', 'AMRL1', 'ANPT2', 'ANTA2', 'ANVC1', 'APAM2', 'APCF1', 'APNM4', 'APRP7', 'AROP4', 'ARPF1', 'ASTO3', 'ATGM1', 'ATKA2', 'AWRT2', 'BABT2', 'BARA9', 'BATN6', 'BAXC1', 'BDRN4', 'BDSP1', 'BFTN7', 'BGCF1', 'BGNN6', 'BHBM3', 'BHRI3', 'BIGM4', 'BISM2', 'BKBF1', 'BKTL1', 'BLIF1', 'BLTA2', 'BLTM2', 'BLTM3', 'BRHC3', 'BRND1', 'BSBM4', 'BUFN6', 'BYGL1', 'BZBM3', 'BZST2', 'CAMM2', 'CAPL1', 'CARL1', 'CASM1', 'CBRW3', 'CDEA2', 'CDXA2', 'CECC1', 'CFWM1', 'CHAO3', 'CHAV3', 'CHBV2', 'CHCM2', 'CHDS1', 'CHII2', 'CHSV3', 'CHTM3', 'CHTS1', 'CHYV2', 'CHYW1', 'CLBP4', 'CLSM4', 'CMAN4', 'CMLN3', 'CMPO1', 'CMTI2', 'CNDO1', 'CNII2', 'COVM2', 'CPMW1', 'CPNW1', 'CPTR1', 'CPVM2', 'CRGA2', 'CRVA2', 'CRYV2', 'CSPA2', 'CWBF1', 'DELD1', 'DMSF1', 'DOMV2', 'DPXC1', 'DTLM4', 'DUKN7', 'DULM5', 'EBEF1', 'EINL1', 'ELFA2', 'EMAT2', 'EPTT2', 'EREP1', 'EROA2', 'ERXA2', 'ESPP4', 'FAIO1', 'FHPF1', 'FMOA1', 'FMRF1', 'FOXR1', 'FPKG1', 'FPST2', 'FPTM4', 'FRCB6', 'FRDF1', 'FRDW1', 'FREL1', 'FRVM3', 'FRWL1', 'FRXM3', 'FSKM2', 'FSNM2', 'FSTI2', 'FTGM4', 'FTPC1', 'GBWW3', 'GCTF1', 'GDMM5', 'GELO1', 'GEXA2', 'GISL1', 'GIXA2', 'GNJT2', 'GRIM4', 'GRMM4', 'GRRT2', 'GSLM4', 'GTLM4', 'GTOT2', 'GTRM4', 'GUXA2', 'HAXA2', 'HBYC1', 'HCGN7', 'HHLO1', 'HIST2', 'HLNM4', 'HMSA2', 'HRBM4', 'HRVC1', 'ICAC1', 'ICYA2', 'ILOH1', 'IRDT2', 'ITKA2', 'JAKI2', 'JLXA2', 'JMLA2', 'JMPN7', 'JNEA2', 'JNGA2', 'JXUF1', 'KDAA2', 'KECA2', 'KEXA2', 'KGCA2', 'KLIH1', 'KNSW3', 'KPTN6', 'KPTV2', 'KWHH1', 'KWJP8', 'KWNW3', 'KYWF1', 'LAMV3', 'LAPW1', 'LCLL1', 'LCNA2', 'LDLC3', 'LDTM4', 'LIXA2', 'LJAC1', 'LJPC1', 'LMFS1', 'LNDC1', 'LOPL1', 'LOPW1', 'LORO1', 'LPNM4', 'LTBV3', 'LTJF1', 'LTRM4', 'LUIT2', 'LUML1', 'LWSD1', 'LWTV2', 'MACM4', 'MBET2', 'MBIN7', 'MBPA1', 'MBRM4', 'MCGA1', 'MCGM4', 'MCYI3', 'MEEM4', 'MEYC1', 'MGIP4', 'MGPT2', 'MGZP4', 'MHBT2', 'MHRN6', 'MISP4', 'MKGM4', 'MLWW3', 'MNMM4', 'MNPV2', 'MOKH1', 'MQTT2', 'MRCP1', 'MRHO1', 'MRNA2', 'MROS1', 'MRYA2', 'MTBF1', 'MTKN6', 'MVXA2', 'MXXA2', 'MYPF1', 'MZXC1', 'NABM4', 'NBBA3', 'NBLP1', 'NCDV2', 'NCHT2', 'NEAW1', 'NFDF1', 'NIAN6', 'NJLC1', 'NKLA2', 'NKTA2', 'NKXA2', 'NLNC3', 'NMTA2', 'NPDW3', 'NPSF1', 'NREP1', 'NTBC1', 'NTKM3', 'NUET2', 'NWCL1', 'NWHC3', 'NWPR1', 'NWWH1', 'OBGN6', 'OBLA1', 'OBXC1', 'OCIM2', 'OHBC1', 'OKSI2', 'OKXC1', 'OLCN6', 'OLSA2', 'OMHC1', 'OOUH1', 'OPTF1', 'ORIN7', 'OSGN6', 'OTNM4', 'OVIA2', 'PACF1', 'PACT2', 'PAXA2', 'PBPA2', 'PCBF1', 'PCGT2', 'PCLF1', 'PCNT2', 'PCOC1', 'PEGF1', 'PFDC1', 'PFXC1', 'PGBP7', 'PGXA2', 'PHBP1', 'PILL1', 'PLXA2', 'PMAF1', 'PMNT2', 'PNGW3', 'PNLM4', 'PNLM6', 'PORO3', 'PORT2', 'PPTM2', 'PPXC1', 'PRDA2', 'PRJC1', 'PRTA2', 'PRUR1', 'PRYC1', 'PSBC1', 'PSBM1', 'PSCM4', 'PSLC1', 'PSTL1', 'PSTN6', 'PSXC1', 'PTAW1', 'PTBM6', 'PTCR1', 'PTIM4', 'PTIT2', 'PTLA2', 'PTOA1', 'PTRP4', 'PTWW1', 'PVDR1', 'PWAW3', 'PXAC1', 'PXOC1', 'PXSC1', 'QPTR1', 'RCKM4', 'RCMC1', 'RCPT2', 'RCRN6', 'RDDA2', 'RDYD1', 'RIXA2', 'RLIT2', 'RLOT2', 'ROBN4', 'RPLV2', 'RPRN6', 'RSJT2', 'RTAT2', 'RTYC1', 'SAPF1', 'SBBN2', 'SBEO3', 'SBLM4', 'SCXA2', 'SDBC1', 'SDHN4', 'SDIA2', 'SDRT2', 'SGNT2', 'SHBL1', 'SHPF1', 'SHXA2', 'SISA2', 'SJNP4', 'SJOM4', 'SJSN4', 'SKCF1', 'SKTA2', 'SKXA2', 'SLIM2', 'SLVM5', 'SLXA2', 'SNDA2', 'SNDP5', 'SRLM4', 'STXA2', 'SVNM4', 'SWLA2', 'SWPM4', 'SWPV2', 'SXHW3', 'TAQT2', 'TAWM4', 'TBIM4', 'TCBM2', 'TCMW1', 'TCNW1', 'TESL1', 'THLO1', 'THRO1', 'TKEA2', 'TLBO3', 'TOKW1', 'TPAF1', 'TRBL1', 'TRDF1', 'TSHF1', 'TWCO1', 'TXPT2', 'ULRA2', 'UNLA2', 'UPBC1', 'VAKF1', 'VBBA3', 'VCAF1', 'VCAT2', 'VCVA2', 'VDZA2', 'WAHV2', 'WAKP8', 'WASD2', 'WATS1', 'WDEL1', 'WDSV2', 'WFPM4', 'WHRI2', 'WLON7', 'WNEM4', 'WPTW1', 'WSLM4', 'WYCM6', 'YATA2', 'YKRV2', 'YKTV2']

legal_stations_2022 = ['41110', '41113', '41114', '41115', '41117', '41159', '42097', '42098', '42099', '44022', '44039', '44040', '44056', '44073', '44086', '44087', '44089', '44090', '44091', '44095', '44097', '44098', '44099', '44100', '45174', '45180', '46092', '46114', '46211', '46213', '46214', '46215', '46218', '46219', '46221', '46222', '46224', '46225', '46229', '46232', '46235', '46239', '46240', '46243', '46244', '46246', '46248', '46251', '46253', '46254', '46256', '46258', '46259', '46265', '51201', '51202', '51205', '51206', '51207', '51208', '51209', '51212', '51213', '52200', '52202', '52211', '52212', 'AAMC1', 'ACYN4', 'ADKA2', 'AGCM4', 'AGXC1', 'ALIA2', 'ALXN6', 'AMRL1', 'ANPT2', 'ANTA2', 'ANVC1', 'APAM2', 'APCF1', 'APNM4', 'APRP7', 'AROP4', 'ARPF1', 'ASTO3', 'ATGM1', 'ATKA2', 'AWRT2', 'BABT2', 'BARA9', 'BATN6', 'BAXC1', 'BDRN4', 'BDSP1', 'BFTN7', 'BGCF1', 'BGNN6', 'BHBM3', 'BHRI3', 'BIGM4', 'BISM2', 'BKBF1', 'BKTL1', 'BLIF1', 'BLTA2', 'BLTM2', 'BLTM3', 'BRHC3', 'BRND1', 'BSBM4', 'BUFN6', 'BYGL1', 'BZBM3', 'BZST2', 'CAMM2', 'CAPL1', 'CARL1', 'CASM1', 'CBLO1', 'CBRW3', 'CDEA2', 'CDXA2', 'CECC1', 'CFWM1', 'CHAO3', 'CHAV3', 'CHBV2', 'CHCM2', 'CHDS1', 'CHII2', 'CHSV3', 'CHTM3', 'CHTS1', 'CHYV2', 'CHYW1', 'CLBP4', 'CLSM4', 'CMAN4', 'CMLN3', 'CMPO1', 'CMTI2', 'CNDO1', 'CNII2', 'COVM2', 'CPMW1', 'CPNW1', 'CPTR1', 'CPVM2', 'CRGA2', 'CRVA2', 'CRYV2', 'CSPA2', 'CWBF1', 'DELD1', 'DMSF1', 'DOMV2', 'DPXC1', 'DTLM4', 'DUKN7', 'DULM5', 'EBEF1', 'EINL1', 'ELFA2', 'EMAT2', 'EPTT2', 'EREP1', 'EROA2', 'ERXA2', 'ESPP4', 'FAIO1', 'FHPF1', 'FMOA1', 'FMRF1', 'FOXR1', 'FPKG1', 'FPST2', 'FPTM4', 'FRDF1', 'FRDW1', 'FRVM3', 'FRWL1', 'FRXM3', 'FSKM2', 'FSNM2', 'FTGM4', 'FTPC1', 'GBWW3', 'GCTF1', 'GDMM5', 'GELO1', 'GEXA2', 'GISL1', 'GIXA2', 'GNJT2', 'GRIM4', 'GRMM4', 'GRRT2', 'GSLM4', 'GTLM4', 'GTOT2', 'GTRM4', 'GUXA2', 'HAXA2', 'HBYC1', 'HCGN7', 'HHLO1', 'HIST2', 'HLNM4', 'HMSA2', 'HRBM4', 'HRVC1', 'ICAC1', 'ICYA2', 'ILOH1', 'IRDT2', 'ITKA2', 'JAKI2', 'JLXA2', 'JMLA2', 'JMPN7', 'JNEA2', 'JNGA2', 'JXUF1', 'KDAA2', 'KECA2', 'KEXA2', 'KGCA2', 'KLIH1', 'KNSW3', 'KPTN6', 'KPTV2', 'KWHH1', 'KWJP8', 'KWNW3', 'KYWF1', 'LAMV3', 'LAPW1', 'LCLL1', 'LCNA2', 'LDLC3', 'LDTM4', 'LIXA2', 'LJAC1', 'LJPC1', 'LMFS1', 'LNDC1', 'LOPL1', 'LOPW1', 'LORO1', 'LPNM4', 'LTBV3', 'LTJF1', 'LTRM4', 'LUIT2', 'LWSD1', 'LWTV2', 'MACM4', 'MBET2', 'MBIN7', 'MBPA1', 'MBRM4', 'MCGA1', 'MCGM4', 'MCYI3', 'MEEM4', 'MEYC1', 'MGIP4', 'MGPT2', 'MGZP4', 'MHBT2', 'MHRN6', 'MISP4', 'MKGM4', 'MLWW3', 'MNMM4', 'MNPV2', 'MOKH1', 'MRCP1', 'MRHO1', 'MRNA2', 'MROS1', 'MRYA2', 'MTBF1', 'MTKN6', 'MVXA2', 'MXXA2', 'MYPF1', 'MZXC1', 'NABM4', 'NBLP1', 'NCDV2', 'NCHT2', 'NEAW1', 'NFDF1', 'NIAN6', 'NJLC1', 'NKLA2', 'NKTA2', 'NKXA2', 'NLNC3', 'NMTA2', 'NPDW3', 'NPSF1', 'NREP1', 'NSTP6', 'NTBC1', 'NTKM3', 'NUET2', 'NWCL1', 'NWHC3', 'NWPR1', 'NWWH1', 'OBGN6', 'OBLA1', 'OBXC1', 'OCIM2', 'OHBC1', 'OKSI2', 'OKXC1', 'OLCN6', 'OLSA2', 'OMHC1', 'OOUH1', 'OPTF1', 'ORIN7', 'OSGN6', 'OTNM4', 'OVIA2', 'PACF1', 'PACT2', 'PAXA2', 'PBPA2', 'PCBF1', 'PCGT2', 'PCLF1', 'PCLM4', 'PCNT2', 'PCOC1', 'PEGF1', 'PFDC1', 'PFXC1', 'PGBP7', 'PGXA2', 'PHBP1', 'PILL1', 'PLXA2', 'PMAF1', 'PMNT2', 'PNGW3', 'PNLM4', 'PNLM6', 'PORO3', 'PORT2', 'PPTM2', 'PPXC1', 'PRDA2', 'PRJC1', 'PRTA2', 'PRUR1', 'PRYC1', 'PSBC1', 'PSBM1', 'PSCM4', 'PSLC1', 'PSTL1', 'PSTN6', 'PSXC1', 'PTAW1', 'PTBM6', 'PTCR1', 'PTIM4', 'PTIT2', 'PTLA2', 'PTOA1', 'PTRP4', 'PTWW1', 'PVDR1', 'PWAW3', 'PXAC1', 'PXOC1', 'PXSC1', 'QPTR1', 'RCKM4', 'RCMC1', 'RCPT2', 'RCRN6', 'RDDA2', 'RDYD1', 'RIXA2', 'RLIT2', 'RLOT2', 'ROBN4', 'RPLV2', 'RPRN6', 'RSJT2', 'RTAT2', 'RTYC1', 'SAPF1', 'SBEO3', 'SBLM4', 'SCXA2', 'SDBC1', 'SDHN4', 'SDIA2', 'SDRT2', 'SGNT2', 'SHBL1', 'SHPF1', 'SHXA2', 'SISA2', 'SJNP4', 'SJOM4', 'SJSN4', 'SKCF1', 'SKTA2', 'SKXA2', 'SLIM2', 'SLVM5', 'SLXA2', 'SNDA2', 'SNDP5', 'SRLM4', 'STXA2', 'SVNM4', 'SWLA2', 'SWPM4', 'SWPV2', 'SXHW3', 'TAQT2', 'TAWM4', 'TBIM4', 'TCBM2', 'TCMW1', 'TCNW1', 'TESL1', 'THLO1', 'THRO1', 'TKEA2', 'TLBO3', 'TOKW1', 'TPAF1', 'TRDF1', 'TSHF1', 'TWCO1', 'TXPT2', 'ULRA2', 'UNLA2', 'UPBC1', 'VAKF1', 'VCAF1', 'VCAT2', 'VCVA2', 'VDZA2', 'WAHV2', 'WAKP8', 'WASD2', 'WATS1', 'WDSV2', 'WFPM4', 'WHRI2', 'WLON7', 'WNEM4', 'WPTW1', 'WSLM4', 'WYCM6', 'YATA2', 'YGNN6', 'YKRV2', 'YKTV2']

legal_stations_2018_to_2022 = list(set(legal_stations_2018).intersection(set(legal_stations_2019)).intersection(set(legal_stations_2020)).intersection(set(legal_stations_2021)).intersection(set(legal_stations_2022)))

legal_stations_2018_to_2022.sort()

# Metrics to compute statistics for
metrics = ['WVHT', 'DPD', 'WTMP']
columns_of_interest = [8, 9, 14]  # Indices of WVHT, DPD, WTMP in the data rows (0-based)

# Initialize data storage
station_data = defaultdict(lambda: defaultdict(lambda: defaultdict(dict)))

# Scrape data for each station and year
for station in legal_stations_2018_to_2022:
    for year in range(2018, 2023):
        print(f"Processing station {station} for year {year}")
        url = f"https://www.ndbc.noaa.gov/view_text_file.php?filename={station.lower()}h{str(year)}.txt.gz&dir=data/historical/stdmet/"
        response = requests.get(url)
        
        if response.status_code == 200:
            data = response.text
            lines = data.splitlines()
            data_lines = [line for line in lines if not line.startswith("#")]
            rows = [line.split() for line in data_lines]

            # Convert data into a DataFrame
            df = pd.DataFrame(rows, columns=[
                "YY", "MM", "DD", "hh", "mm", "WDIR", "WSPD", "GST", "WVHT", 
                "DPD", "APD", "MWD", "PRES", "ATMP", "WTMP", "DEWP", "VIS", "TIDE"
            ])
            
            # Ensure numeric columns are properly converted
            for col in columns_of_interest:
                df.iloc[:, col] = pd.to_numeric(df.iloc[:, col], errors='coerce')
            
            # Filter the necessary columns and group by month
            df['MM'] = pd.to_numeric(df['MM'], errors='coerce')
            monthly_stats = df.groupby("MM").agg({
                df.columns[col]: ['mean', 'median'] for col in columns_of_interest
            })

            # Flatten column names and store in JSON-friendly structure
            for month, data in monthly_stats.iterrows():
                station_data[station][year][month] = {
                    f"{metric}_{stat}": data[(df.columns[columns_of_interest[idx]], stat)]
                    for idx, metric in enumerate(metrics)
                    for stat in ['mean', 'median']
                }
        else:
            print(f"Failed to fetch data for station {station}, year {year}")

# Save the data as JSON
with open("outputs/station_data_monthly.json", "w") as json_file:
    json.dump(station_data, json_file, indent=4)

print("Data saved to station_data_monthly.json")
